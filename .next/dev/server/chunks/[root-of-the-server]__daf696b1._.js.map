{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/amandab/quantumpharm/app/api/v1/users/me/profile/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\n\n/**\n * API Contract for User Profile Updates\n * \n * There are two API endpoints, GET and PATCH\n * Please note that none of these APIs require authentication, \n * but would need to be added in production for security. \n * \n * GET /api/v1/users/me/profile\n * - Returns current user profile\n * \n * PATCH /api/v1/users/me/profile\n * - Updates user profile fields\n * - Requires If-Match header with version number (for optimistic locking)\n * - Only allows updating: name, email, Home address\n * - Protected fields (id, role, etc.) cannot be updated\n */\n\n// Mock database \nlet mockUser = {\n  id: 'usr_123',\n  name: 'John Doe',\n  email: 'john@example.com',\n  emailVerified: true,\n  street: '123 Main St',\n  city: 'San Francisco',\n  state: 'CA',\n  zipCode: '94102',\n  version: 1,\n  updatedAt: new Date().toISOString()\n};\n\n/**\n  This function handles GET requests to the API endpoint -\n  it's how the frontend retrieves the user's profile data.\n */\nexport async function GET(request: NextRequest) {\n  return NextResponse.json({\n    data: mockUser,\n    meta: {\n      requestId: generateRequestId(),\n      timestamp: new Date().toISOString()\n    }\n  });\n}\n\n/**\n The optimistic locking feature -\n What it does: It checks the version number \n Why: It prevent data conflicts and prevents data loss.\n \n Without this check, if two people edit the profile at the same time:\n Person A changes name to \"Tony\" (version 1 to version 2)\n Person B changes name to \"Amanda\" (version 1 to ?)\n Person B's change would overwrite Tony's work\n\n So basically Optimistic locking lets everyone try to edit, \n but only the first update goes through. \n Others must reload to get the latest data before making more changes.\n Itâ€™s not a hard lock, but a way to prevent accidental overwrites.\n */\n\nexport async function PATCH(request: NextRequest) {\n  try {\n\n    // 1. Check If-Match header for version control\n    // This line reads the value of the \"If- Match\" header from incoming Http request (frontend) \n    const ifMatch = request.headers.get('if-match'); \n    \n    // If the frotend does not send an \"If-Match\" value then it goes into this code block\n    if (!ifMatch) {\n      return NextResponse.json({\n        error: {\n          code: 'MISSING_IF_MATCH',\n          message: 'If-Match header is required for version control',\n          requestId: generateRequestId(),\n          timestamp: new Date().toISOString()\n        }\n      }, { status: 400 });\n    }\n    \n    const requestedVersion = parseInt(ifMatch, 10);\n    \n    // 2. Check for version conflict (optimistic locking)\n    // It stops updates if the profile has changed since the client last loaded it,\n    // ensuring data consistency and preventing lost updates.\n    if (requestedVersion !== mockUser.version) {\n      return NextResponse.json({\n        error: {\n          code: 'VERSION_CONFLICT',\n          message: 'Profile was updated by another session. Please refresh and try again.',\n          requestId: generateRequestId(),\n          timestamp: new Date().toISOString(),\n          details: {\n            currentVersion: mockUser.version,\n            attemptedVersion: requestedVersion\n          }\n        }\n      }, { status: 409 });\n    }\n    \n    // 3. Parse and validate request body\n    // These next two lines gets the updated profile fields sent by client,\n    // so backend can validate and process them\n    const body = await request.json();\n    const { name, email, bio, street, city, state, zipCode } = body;\n    \n    // Basic validation to see if the user is entering correct values in input fields\n    const errors: Record<string, any> = {};\n    \n    if (name !== undefined) {\n      const trimmedName = name.trim();\n      if (\n        typeof name !== 'string' ||\n        trimmedName.length < 2 ||\n        /[^a-zA-Z\\s]/.test(trimmedName) || // name contains any non-letter, non-space\n        /\\s{2,}/.test(trimmedName) || // consecutive spaces\n        /^\\s|\\s$/.test(name) // leading or trailing space (shouldn't happen after trim, but extra check)\n      ) {\n        errors.name = {\n          code: 'INVALID_NAME',\n          message: 'Name must be at least 2 characters, contain only letters, and have only single spaces between words'\n        };\n      }\n    }\n    \n    if (email !== undefined) {\n      if (typeof email !== 'string' || !email.includes('@')) {\n        errors.email = {\n          code: 'INVALID_FORMAT',\n          message: 'Email must be a valid email address'\n        };\n      }\n    }\n    \n    if (bio !== undefined && typeof bio === 'string' && bio.length > 500) {\n      errors.bio = {\n        code: 'TOO_LONG',\n        message: 'Bio must not exceed 500 characters'\n      };\n    }\n    \n    if (zipCode !== undefined && typeof zipCode === 'string') {\n      const zipPattern = /^\\d{5}(-\\d{4})?$/;\n      if (!zipPattern.test(zipCode)) {\n        errors.zipCode = {\n          code: 'INVALID_FORMAT',\n          message: 'Zip code must be in format 12345 or 12345-6789'\n        };\n      }\n    }\n    \n    if (state !== undefined && typeof state === 'string' && state.length !== 2) {\n      errors.state = {\n        code: 'INVALID_FORMAT',\n        message: 'State must be a 2-letter code (e.g., CA, NY)'\n      };\n    }\n    \n    // Return validation errors\n    if (Object.keys(errors).length > 0) {\n      return NextResponse.json({\n        error: {\n          code: 'VALIDATION_FAILED',\n          message: 'Invalid profile data',\n          requestId: generateRequestId(),\n          timestamp: new Date().toISOString(),\n          fields: errors\n        }\n      }, { status: 422 });\n    }\n    \n    // 4. Update profile\n    const updates: any = {};\n    if (name !== undefined) updates.name = name.trim();\n    if (email !== undefined) updates.email = email.trim().toLowerCase();\n    if (bio !== undefined) updates.bio = bio.trim();\n    if (street !== undefined) updates.street = street.trim();\n    if (city !== undefined) updates.city = city.trim();\n    if (state !== undefined) updates.state = state.trim().toUpperCase();\n    if (zipCode !== undefined) updates.zipCode = zipCode.trim();\n    \n    // Check what changed\n    const nameChanged = name !== undefined && name.trim() !== mockUser.name;\n    const emailChanged = email !== undefined && email.trim().toLowerCase() !== mockUser.email;\n    const addressChanged = (street !== undefined && street.trim() !== mockUser.street) ||\n                          (city !== undefined && city.trim() !== mockUser.city) ||\n                          (state !== undefined && state.trim().toUpperCase() !== mockUser.state) ||\n                          (zipCode !== undefined && zipCode.trim() !== mockUser.zipCode);\n    \n    mockUser = {\n      ...mockUser,\n      ...updates,\n      emailVerified: emailChanged ? false : mockUser.emailVerified,\n      version: mockUser.version + 1,\n      updatedAt: new Date().toISOString()\n    };\n    \n    // 5. Build warnings and success message\n    const warnings = [];\n    let successMessage = null;\n    \n    if (emailChanged) {\n      warnings.push({\n        code: 'EMAIL_VERIFICATION_REQUIRED',\n        message: 'Check your email to verify your new address'\n      });\n      successMessage = 'New email saved';\n    } else if (nameChanged) {\n      successMessage = 'New name saved';\n    } else if (addressChanged) {\n      successMessage = 'New address saved';\n    }\n    \n    // 6. Return success response\n    return NextResponse.json({\n      data: mockUser,\n      meta: {\n        requestId: generateRequestId(),\n        timestamp: new Date().toISOString(),\n        warnings: warnings.length > 0 ? warnings : undefined,\n        successMessage: successMessage\n      }\n    });\n    \n  } catch (error) {\n    // Handle unexpected errors\n    return NextResponse.json({\n      error: {\n        code: 'INTERNAL_SERVER_ERROR',\n        message: 'An unexpected error occurred',\n        requestId: generateRequestId(),\n        timestamp: new Date().toISOString()\n      }\n    }, { status: 500 });\n  }\n}\n\n/**\n * Generate unique request ID for tracing\n * It combines the current timestamp and a random string to help trace,\n *  debug, and identify individual requests in logs or error messages. \n * This makes it easier to track and troubleshoot specific API calls.\n */\nfunction generateRequestId(): string {\n  return `req_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\n}\n"],"names":[],"mappings":"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"}}]
}